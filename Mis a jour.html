<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Budget Personnel Kawaii</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et adaptatif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #faf5ff; /* Lavande pastel très clair */
        }
        .transaction-card {
            transition: all 0.3s ease;
            border-radius: 1rem; /* Bords plus ronds */
        }
        .transaction-card:hover {
            box-shadow: 0 6px 16px rgba(249, 168, 212, 0.3); /* Ombre rose douce */
            transform: translateY(-3px);
        }
        /* Couleurs Thème Kawaii */
        .income {
            border-left-color: #a7f3d0; /* Vert menthe pastel (Emerald 200) */
        }
        .expense {
            border-left-color: #fda4af; /* Rose framboise pastel (Rose 300) */
        }
        .balance-positive {
            color: #10b981; /* Vert, gardé fort pour la clarté financière */
        }
        .balance-negative {
            color: #ef4444; /* Rouge, gardé fort pour la clarté financière */
        }
        /* Style pour l'indicateur de chargement */
        #loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #faf5ff;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f9a8d4; /* Rose pastel */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Utilisation des variables globales du Canvas (elles sont VIDES dans l'APK)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        let isDatabaseEnabled = true; // Nouveau drapeau pour contrôler l'accès à la BDD

        // Fonction pour formater le montant en devise (Euro)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        };

        // Fonction pour initialiser Firebase et l'authentification
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing. Running in UI-only mode.");
                document.getElementById('loading-text').textContent = "Erreur: Configuration Firebase manquante. Les données ne sont pas sauvegardées.";
                
                // NOUVEAU: Désactiver la base de données et charger l'interface utilisateur.
                isDatabaseEnabled = false;
                userId = 'no-db-user'; // ID temporaire pour l'affichage
                document.getElementById('user-id-display').textContent = "ID Utilisateur: Mode sans sauvegarde";
                
                // Cacher l'indicateur de chargement et afficher l'application
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                
                // Simuler une liste de transactions vide pour le rendu initial
                renderTransactions([], 0, 0); 
                return; // Sortir après avoir affiché l'UI
            }

            // setLogLevel('debug'); // Décommenter pour le débogage de Firestore

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isDatabaseEnabled = true;

                // 1. Authentification
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. Écouter les changements d'état d'authentification
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Authenticated with userId:", userId);
                        document.getElementById('user-id-display').textContent = `ID Utilisateur: ${userId}`;
                        loadTransactions(); 
                    } else {
                        userId = null;
                        isAuthReady = true;
                        console.log("Signed out or anonymous.");
                        loadTransactions();
                    }
                    // Cacher l'indicateur de chargement
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('app-content').classList.remove('hidden');
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('loading-text').textContent = `Erreur de connexion: ${error.message}.`;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                isDatabaseEnabled = false;
                renderTransactions([], 0, 0); // Assurer le rendu de l'interface même en cas d'erreur
            }
        };

        // Fonction pour obtenir le chemin de la collection
        const getCollectionPath = () => {
            if (!userId) {
                // Collection pour les utilisateurs non authentifiés (non recommandable pour la production)
                // On utilise un ID aléatoire si pas d'authentification pour stocker temporairement les données
                const tempId = localStorage.getItem('tempUserId') || crypto.randomUUID();
                localStorage.setItem('tempUserId', tempId);
                return `artifacts/${appId}/users/${tempId}/transactions`;
            }
            // Chemin de collection privé pour l'utilisateur
            return `artifacts/${appId}/users/${userId}/transactions`;
        }

        // --- Opérations CRUD Firestore ---

        const loadTransactions = () => {
            if (!isDatabaseEnabled) return; // BLOQUER si la BDD est désactivée
            
            if (!isAuthReady || !db) {
                if (!db) {
                    console.error("Base de données non initialisée.");
                    return;
                }
            }

            const path = getCollectionPath();
            const q = query(collection(db, path));
            
            // Écouter les changements en temps réel (onSnapshot)
            onSnapshot(q, (snapshot) => {
                const transactions = [];
                let totalIncome = 0;
                let totalExpense = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Assurer que le montant est un nombre
                    const amount = Number(data.amount) || 0; 
                    
                    if (data.type === 'income') {
                        totalIncome += amount;
                    } else if (data.type === 'expense') {
                        totalExpense += amount;
                    }

                    transactions.push({ id: doc.id, ...data, amount: amount });
                });
                
                // Trier les transactions par date de création (les plus récentes en premier)
                transactions.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                
                renderTransactions(transactions, totalIncome, totalExpense);
            }, (error) => {
                console.error("Error fetching transactions: ", error);
                document.getElementById('transaction-list').innerHTML = `<p class="text-red-500 p-4">Erreur de chargement : ${error.message}</p>`;
            });
        };

        const addTransaction = async (description, amount, type) => {
            if (!isDatabaseEnabled || !db) {
                 // Message d'erreur pour l'utilisateur
                 showCustomAlert("Sauvegarde impossible", "Les données ne peuvent pas être enregistrées. La configuration Firebase est manquante.");
                 return;
            }
            if (!description.trim() || !amount || amount <= 0) return;

            const path = getCollectionPath();
            
            try {
                await addDoc(collection(db, path), {
                    description: description.trim(),
                    amount: amount, // Stocké comme nombre
                    type: type, // 'income' ou 'expense'
                    createdAt: serverTimestamp()
                });
                
                // Vider le formulaire après succès
                document.getElementById('new-transaction-form').reset();
            } catch (e) {
                console.error("Erreur lors de l'ajout de la transaction: ", e);
            }
        };

        const deleteTransaction = async (id) => {
            if (!isDatabaseEnabled || !db) {
                showCustomAlert("Suppression impossible", "La configuration Firebase est manquante, aucune donnée n'est enregistrée.");
                return;
            }

            // Afficher une boîte de dialogue de confirmation personnalisée
            showCustomConfirm('Confirmer la suppression', 'Êtes-vous sûr de vouloir supprimer cette transaction ?', async () => {
                const path = getCollectionPath();
                try {
                    await deleteDoc(doc(db, path, id));
                } catch (e) {
                    console.error("Erreur lors de la suppression de la transaction: ", e);
                }
            });
        };
        
        // --- Rendu de l'UI ---
        
        const renderTransactions = (transactions, totalIncome, totalExpense) => {
            const list = document.getElementById('transaction-list');
            list.innerHTML = ''; // Vider la liste actuelle

            const balance = totalIncome - totalExpense;
            // Pour la clarté financière, on garde des couleurs fortes ici.
            const balanceClass = balance >= 0 ? 'balance-positive' : 'balance-negative'; 

            // Mettre à jour la carte de résumé
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('total-balance').textContent = formatCurrency(balance);
            document.getElementById('total-balance').className = `text-3xl font-bold ${balanceClass}`;


            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune transaction enregistrée. Ajoutez-en une nouvelle !</p>';
                return;
            }

            transactions.forEach(tx => {
                const li = document.createElement('li');
                const isIncome = tx.type === 'income';
                const sign = isIncome ? '+' : '-';
                const colorClass = isIncome ? 'income' : 'expense';
                
                // Classes de style Tailwind
                li.className = `transaction-card flex items-center justify-between p-4 mb-3 bg-white rounded-xl shadow-md border-l-4 ${colorClass}`;
                
                li.innerHTML = `
                    <div class="flex flex-col flex-1 min-w-0">
                        <span class="text-lg font-medium text-gray-800 break-words pr-4">
                            ${tx.description}
                        </span>
                        <span class="text-sm text-gray-500">
                            ${isIncome ? 'Revenu' : 'Dépense'}
                        </span>
                    </div>

                    <div class="flex items-center space-x-4">
                        <!-- Montant : Utilisation de couleurs mignonnes pour les transactions individuelles -->
                        <span class="text-xl font-bold ${isIncome ? 'text-emerald-500' : 'text-rose-500'}">
                            ${sign} ${formatCurrency(tx.amount)}
                        </span>
                        
                        <!-- Bouton de suppression -->
                        <button class="text-rose-300 hover:text-rose-500 p-2 rounded-full transition-colors duration-200 focus:outline-none"
                                onclick="window.deleteTransaction('${tx.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });
        };

        // --- Gestion des événements et UI personnalisée (pas d'alertes) ---

        const handleAddTransaction = (event) => {
            event.preventDefault(); // Empêche l'envoi du formulaire
            const descriptionInput = document.getElementById('description-input');
            const amountInput = document.getElementById('amount-input');
            const typeInput = document.querySelector('input[name="transaction-type"]:checked');

            const description = descriptionInput.value;
            const amount = parseFloat(amountInput.value); // Utiliser float pour les montants
            const type = typeInput ? typeInput.value : 'expense'; // Dépense par défaut

            if (description.trim() === "" || isNaN(amount) || amount <= 0) {
                 console.error("Veuillez saisir une description et un montant valide (> 0).");
                 return;
            }

            addTransaction(description, amount, type);
        };
        
        // NOUVEAU: Fonction pour afficher un message d'alerte simple
        const showCustomAlert = (title, message) => {
            const modal = document.getElementById('custom-confirm-modal');
            const modalTitle = document.getElementById('confirm-title');
            const modalMessage = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-yes-btn');
            const cancelBtn = document.getElementById('confirm-no-btn');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Afficher seulement le bouton OK (confirm-yes-btn)
            confirmBtn.textContent = "OK";
            confirmBtn.classList.remove('bg-rose-400', 'hover:bg-rose-500');
            confirmBtn.classList.add('bg-pink-400', 'hover:bg-pink-500');
            cancelBtn.classList.add('hidden');
            
            // Fonction pour fermer
            const close = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleClose);
                // Réinitialiser le modal pour la confirmation
                confirmBtn.textContent = "Confirmer";
                confirmBtn.classList.remove('bg-pink-400', 'hover:bg-pink-500');
                confirmBtn.classList.add('bg-rose-400', 'hover:bg-rose-500');
                cancelBtn.classList.remove('hidden');
            };

            const handleClose = () => {
                close();
            };

            confirmBtn.addEventListener('click', handleClose);
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    close();
                }
            };

            modal.classList.remove('hidden');
        };

        // Afficher un modal de confirmation personnalisé (au lieu de confirm())
        const showCustomConfirm = (title, message, callback) => {
            const modal = document.getElementById('custom-confirm-modal');
            const modalTitle = document.getElementById('confirm-title');
            const modalMessage = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-yes-btn');
            const cancelBtn = document.getElementById('confirm-no-btn');
            
            // Assurer que le modal est en mode Confirmation
            confirmBtn.textContent = "Confirmer";
            confirmBtn.classList.remove('bg-pink-400', 'hover:bg-pink-500');
            confirmBtn.classList.add('bg-rose-400', 'hover:bg-rose-500');
            cancelBtn.classList.remove('hidden');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Fonction pour fermer et nettoyer les événements
            const close = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
            };

            const handleConfirm = () => {
                callback();
                close();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', close);
            
            // Événement pour fermer en cliquant à l'extérieur
            modal.onclick = (e) => {
                if (e.target === modal) {
                    close();
                }
            };

            modal.classList.remove('hidden');
        };

        // Rendre les fonctions globales pour qu'elles soient appelables depuis les boutons HTML
        window.deleteTransaction = deleteTransaction;
        window.showCustomConfirm = showCustomConfirm;
        window.showCustomAlert = showCustomAlert; // Nouvelle fonction pour alerte

        window.onload = () => {
            // Attacher l'écouteur d'événement au formulaire
            document.getElementById('new-transaction-form').addEventListener('submit', handleAddTransaction);

            // Cacher le contenu de l'application tant que Firebase ne s'est pas initialisé
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('loading-indicator').style.display = 'flex';
            
            // Démarrer l'initialisation de Firebase
            initializeFirebase();
        };

    </script>
</head>
<body>
    
    <!-- ---------------------------------------------------- -->
    <!-- Indicateur de Chargement (Visible par défaut) -->
    <!-- ---------------------------------------------------- -->
    <div id="loading-indicator" class="fixed inset-0 z-50">
        <div class="flex flex-col items-center justify-center h-full">
            <div class="spinner"></div>
            <p id="loading-text" class="mt-4 text-pink-500 font-semibold">Chargement des données...</p>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- Contenu Principal de l'Application (Caché au début) -->
    <!-- ---------------------------------------------------- -->
    <div id="app-content" class="min-h-screen p-4 sm:p-8">
        <div class="max-w-3xl mx-auto">
            
            <header class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-gray-800">Mon Budget Kawaii</h1>
                <p id="user-id-display" class="text-xs mt-2 text-gray-500 font-mono break-words">ID Utilisateur: Chargement...</p>
                <div class="mt-2 p-2 bg-yellow-100 border border-yellow-300 text-sm text-yellow-800 rounded-lg" id="db-warning" style="display: none;">
                    ⚠️ Attention : Vos transactions ne sont pas sauvegardées. La base de données est déconnectée.
                </div>
            </header>

            <!-- ---------------------------------------------- -->
            <!-- Tableau de Bord du Solde -->
            <!-- ---------------------------------------------- -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <!-- Solde Total -->
                <div class="bg-white p-6 rounded-xl shadow-lg text-center md:col-span-1">
                    <p class="text-lg text-gray-500">Solde Total</p>
                    <p id="total-balance" class="text-3xl font-bold text-gray-800 mt-2">0,00 €</p>
                </div>
                <!-- Total Revenus -->
                <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                    <p class="text-lg text-gray-500">Revenus</p>
                    <p id="total-income" class="text-3xl font-bold text-emerald-500 mt-2">0,00 €</p>
                </div>
                <!-- Total Dépenses -->
                <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                    <p class="text-lg text-gray-500">Dépenses</p>
                    <p id="total-expense" class="text-3xl font-bold text-rose-500 mt-2">0,00 €</p>
                </div>
            </div>

            <!-- ---------------------------------------------- -->
            <!-- Formulaire d'Ajout de Transaction -->
            <!-- ---------------------------------------------- -->
            <div class="mb-8 bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-400">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Nouvelle Transaction</h2>
                <form id="new-transaction-form" class="space-y-4">
                    
                    <!-- Ligne 1: Description et Montant -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="description-input" placeholder="Description (ex: Achat de jeu, Argent de poche)" required
                            class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400 transition duration-150">
                        
                        <input type="number" id="amount-input" placeholder="Montant (€)" required min="0.01" step="0.01"
                            class="w-full sm:w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:border-pink-400 focus:ring-1 focus:ring-pink-400 transition duration-150 text-right">
                    </div>
                    
                    <!-- Ligne 2: Type de Transaction -->
                    <div class="flex justify-between items-center bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <span class="text-gray-700 font-medium">Type :</span>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="transaction-type" value="income" checked
                                    class="h-5 w-5 text-emerald-500 focus:ring-emerald-500 border-gray-300">
                                <span class="text-emerald-500 font-semibold">Revenu (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="transaction-type" value="expense"
                                    class="h-5 w-5 text-rose-500 focus:ring-rose-500 border-gray-300">
                                <span class="text-rose-500 font-semibold">Dépense (-)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Bouton Ajouter -->
                    <button type="submit"
                            class="w-full bg-pink-400 hover:bg-pink-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-pink-400 focus:ring-opacity-50">
                        Enregistrer la Transaction
                    </button>
                </form>
            </div>

            <!-- ---------------------------------------------- -->
            <!-- Liste des Transactions -->
            <!-- ---------------------------------------------- -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historique</h2>
            <ul id="transaction-list" class="space-y-4">
                <!-- Les transactions seront insérées ici par JavaScript -->
            </ul>

        </div>
    </div>
    
    <!-- ---------------------------------------------------- -->
    <!-- Modal de Confirmation Personnalisé -->
    <!-- ---------------------------------------------------- -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300 scale-100">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4">Confirmation</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Êtes-vous sûr de vouloir continuer ?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-no-btn" class="px-4 py-2 bg-purple-100 text-purple-700 font-semibold rounded-lg hover:bg-purple-200 transition-colors">
                    Annuler
                </button>
                <button id="confirm-yes-btn" class="px-4 py-2 bg-rose-400 text-white font-semibold rounded-lg hover:bg-rose-500 transition-colors">
                    Confirmer
                </button>
            </div>
        </div>
    </div>
</body>
</html>
